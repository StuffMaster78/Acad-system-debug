<template>
  <div class="holiday-management">
    <div class="header">
      <h1>Holiday & Special Days Management</h1>
      <div class="actions">
        <button 
          @click="showCreateModal = true"
          class="btn btn-primary"
        >
          <i class="fas fa-plus"></i> Add Special Day
        </button>
        <button 
          @click="checkReminders"
          class="btn btn-secondary"
          :disabled="checkingReminders"
        >
          <i class="fas fa-bell"></i> Check Reminders
        </button>
        <button 
          @click="autoGenerateDiscounts"
          class="btn btn-success"
          :disabled="generatingDiscounts"
        >
          <i class="fas fa-tag"></i> Auto-Generate Discounts
        </button>
      </div>
    </div>

    <!-- Filters -->
    <div class="filters">
      <div class="filter-group">
        <label>Country:</label>
        <select v-model="filters.country" @change="loadSpecialDays">
          <option value="">All Countries</option>
          <option value="US">United States</option>
          <option value="CA">Canada</option>
          <option value="GB">United Kingdom</option>
          <option value="AU">Australia</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Event Type:</label>
        <select v-model="filters.event_type" @change="loadSpecialDays">
          <option value="">All Types</option>
          <option value="holiday">Holiday</option>
          <option value="special_day">Special Day</option>
          <option value="anniversary">Anniversary</option>
          <option value="seasonal">Seasonal</option>
          <option value="cultural">Cultural</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Status:</label>
        <select v-model="filters.is_active" @change="loadSpecialDays">
          <option value="">All</option>
          <option value="true">Active</option>
          <option value="false">Inactive</option>
        </select>
      </div>
      <div class="filter-group">
        <label>
          <input 
            type="checkbox" 
            v-model="filters.upcoming"
            @change="loadSpecialDays"
          />
          Upcoming Only
        </label>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button 
        :class="['tab', { active: activeTab === 'special-days' }]"
        @click="activeTab = 'special-days'"
      >
        Special Days
      </button>
      <button 
        :class="['tab', { active: activeTab === 'reminders' }]"
        @click="activeTab = 'reminders'"
      >
        Reminders ({{ pendingRemindersCount }})
      </button>
      <button 
        :class="['tab', { active: activeTab === 'campaigns' }]"
        @click="activeTab = 'campaigns'"
      >
        Discount Campaigns
      </button>
    </div>

    <!-- Special Days Tab -->
    <div v-if="activeTab === 'special-days'" class="tab-content">
      <EnhancedDataTable
        :data="specialDays"
        :columns="specialDaysColumns"
        :loading="loading"
        @row-click="viewSpecialDay"
        :actions="specialDayActions"
      />
    </div>

    <!-- Reminders Tab -->
    <div v-if="activeTab === 'reminders'" class="tab-content">
      <EnhancedDataTable
        :data="reminders"
        :columns="remindersColumns"
        :loading="loadingReminders"
        @row-click="viewReminder"
        :actions="reminderActions"
      />
    </div>

    <!-- Campaigns Tab -->
    <div v-if="activeTab === 'campaigns'" class="tab-content">
      <EnhancedDataTable
        :data="campaigns"
        :columns="campaignsColumns"
        :loading="loadingCampaigns"
        @row-click="viewCampaign"
      />
    </div>

    <!-- Create/Edit Special Day Modal -->
    <Modal
      v-if="showCreateModal || editingSpecialDay"
      :show="showCreateModal || !!editingSpecialDay"
      @close="closeModal"
      title="Special Day"
      size="large"
    >
      <SpecialDayForm
        :special-day="editingSpecialDay"
        @save="handleSaveSpecialDay"
        @cancel="closeModal"
      />
    </Modal>

    <!-- Special Day Detail Modal -->
    <Modal
      v-if="selectedSpecialDay"
      :show="!!selectedSpecialDay"
      @close="selectedSpecialDay = null"
      :title="selectedSpecialDay?.name"
      size="large"
    >
      <SpecialDayDetail
        :special-day="selectedSpecialDay"
        @edit="editSpecialDay"
        @generate-discount="generateDiscount"
        @close="selectedSpecialDay = null"
      />
    </Modal>
  </div>
</template>

<script setup>
import { ref, computed, onMounted, watch } from 'vue'
import { useToast } from '@/composables/useToast'
import { holidaysAPI } from '@/api'
import EnhancedDataTable from '@/components/common/EnhancedDataTable.vue'
import Modal from '@/components/common/Modal.vue'
import SpecialDayForm from '@/components/holidays/SpecialDayForm.vue'
import SpecialDayDetail from '@/components/holidays/SpecialDayDetail.vue'

const { showToast } = useToast()

// State
const activeTab = ref('special-days')
const loading = ref(false)
const loadingReminders = ref(false)
const loadingCampaigns = ref(false)
const checkingReminders = ref(false)
const generatingDiscounts = ref(false)
const showCreateModal = ref(false)
const editingSpecialDay = ref(null)
const selectedSpecialDay = ref(null)

const specialDays = ref([])
const reminders = ref([])
const campaigns = ref([])

const filters = ref({
  country: '',
  event_type: '',
  is_active: '',
  upcoming: false
})

// Computed
const pendingRemindersCount = computed(() => {
  return reminders.value.filter(r => r.status === 'pending').length
})

// Columns
const specialDaysColumns = [
  { key: 'name', label: 'Name', sortable: true },
  { key: 'event_type', label: 'Type', sortable: true },
  { key: 'event_date_this_year', label: 'Date', sortable: true },
  { key: 'is_international', label: 'International', type: 'boolean' },
  { key: 'countries_display', label: 'Countries' },
  { key: 'priority', label: 'Priority', sortable: true },
  { key: 'days_until', label: 'Days Until' },
  { key: 'is_active', label: 'Active', type: 'boolean' }
]

const remindersColumns = [
  { key: 'special_day_name', label: 'Special Day', sortable: true },
  { key: 'reminder_date', label: 'Reminder Date', sortable: true },
  { key: 'status', label: 'Status', sortable: true },
  { key: 'broadcast_sent', label: 'Broadcast Sent', type: 'boolean' },
  { key: 'discount_created', label: 'Discount Created', type: 'boolean' },
  { key: 'discount_code', label: 'Discount Code' }
]

const campaignsColumns = [
  { key: 'special_day_name', label: 'Special Day', sortable: true },
  { key: 'year', label: 'Year', sortable: true },
  { key: 'discount_code', label: 'Discount Code' },
  { key: 'discount_percentage', label: 'Discount %' },
  { key: 'is_active', label: 'Active', type: 'boolean' },
  { key: 'auto_generated', label: 'Auto-Generated', type: 'boolean' }
]

// Actions
const specialDayActions = [
  { label: 'Edit', action: 'edit', icon: 'fas fa-edit' },
  { label: 'Generate Discount', action: 'generate-discount', icon: 'fas fa-tag' },
  { label: 'Delete', action: 'delete', icon: 'fas fa-trash', variant: 'danger' }
]

const reminderActions = [
  { label: 'Mark Sent', action: 'mark-sent', icon: 'fas fa-check' },
  { label: 'Create Discount', action: 'create-discount', icon: 'fas fa-tag' }
]

// Methods
const loadSpecialDays = async () => {
  loading.value = true
  try {
    const params = {
      ...filters.value,
      upcoming: filters.value.upcoming ? 'true' : undefined
    }
    Object.keys(params).forEach(key => {
      if (params[key] === '' || params[key] === undefined) {
        delete params[key]
      }
    })
    
    const response = await holidaysAPI.specialDays.list(params)
    specialDays.value = response.data
  } catch (error) {
    showToast('Failed to load special days', 'error')
    console.error(error)
  } finally {
    loading.value = false
  }
}

const loadReminders = async () => {
  loadingReminders.value = true
  try {
    const response = await holidaysAPI.reminders.list({ pending: 'true' })
    reminders.value = response.data
  } catch (error) {
    showToast('Failed to load reminders', 'error')
    console.error(error)
  } finally {
    loadingReminders.value = false
  }
}

const loadCampaigns = async () => {
  loadingCampaigns.value = true
  try {
    const response = await holidaysAPI.campaigns.list()
    campaigns.value = response.data
  } catch (error) {
    showToast('Failed to load campaigns', 'error')
    console.error(error)
  } finally {
    loadingCampaigns.value = false
  }
}

const checkReminders = async () => {
  checkingReminders.value = true
  try {
    await holidaysAPI.reminders.checkAndCreate()
    showToast('Reminders checked successfully', 'success')
    await loadReminders()
  } catch (error) {
    showToast('Failed to check reminders', 'error')
    console.error(error)
  } finally {
    checkingReminders.value = false
  }
}

const autoGenerateDiscounts = async () => {
  generatingDiscounts.value = true
  try {
    const response = await holidaysAPI.specialDays.autoGenerateDiscounts()
    showToast(response.data.message || 'Discounts generated successfully', 'success')
    await loadCampaigns()
  } catch (error) {
    showToast('Failed to generate discounts', 'error')
    console.error(error)
  } finally {
    generatingDiscounts.value = false
  }
}

const viewSpecialDay = (day) => {
  selectedSpecialDay.value = day
}

const editSpecialDay = (day) => {
  editingSpecialDay.value = day
  selectedSpecialDay.value = null
}

const viewReminder = (reminder) => {
  // Navigate to reminder detail or show modal
  console.log('View reminder', reminder)
}

const viewCampaign = (campaign) => {
  // Navigate to campaign detail or show modal
  console.log('View campaign', campaign)
}

const generateDiscount = async (specialDayId, year) => {
  try {
    await holidaysAPI.specialDays.generateDiscount(specialDayId, { year })
    showToast('Discount generated successfully', 'success')
    await loadCampaigns()
    selectedSpecialDay.value = null
  } catch (error) {
    showToast('Failed to generate discount', 'error')
    console.error(error)
  }
}

const handleSaveSpecialDay = async (data) => {
  try {
    if (editingSpecialDay.value) {
      await holidaysAPI.specialDays.update(editingSpecialDay.value.id, data)
      showToast('Special day updated successfully', 'success')
    } else {
      await holidaysAPI.specialDays.create(data)
      showToast('Special day created successfully', 'success')
    }
    closeModal()
    await loadSpecialDays()
  } catch (error) {
    showToast('Failed to save special day', 'error')
    console.error(error)
  }
}

const closeModal = () => {
  showCreateModal.value = false
  editingSpecialDay.value = null
}

// Watch tab changes
watch(activeTab, (newTab) => {
  if (newTab === 'reminders') {
    loadReminders()
  } else if (newTab === 'campaigns') {
    loadCampaigns()
  }
})

// Lifecycle
onMounted(() => {
  loadSpecialDays()
})
</script>

<style scoped>
.holiday-management {
  padding: 2rem;
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 2rem;
}

.header h1 {
  margin: 0;
  font-size: 1.75rem;
  font-weight: 600;
}

.actions {
  display: flex;
  gap: 0.75rem;
}

.filters {
  display: flex;
  gap: 1.5rem;
  margin-bottom: 1.5rem;
  padding: 1rem;
  background: #f9fafb;
  border-radius: 0.5rem;
}

.filter-group {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.filter-group label {
  font-weight: 500;
  font-size: 0.875rem;
}

.filter-group select {
  padding: 0.5rem;
  border: 1px solid #d1d5db;
  border-radius: 0.375rem;
}

.tabs {
  display: flex;
  gap: 0.5rem;
  border-bottom: 2px solid #e5e7eb;
  margin-bottom: 1.5rem;
}

.tab {
  padding: 0.75rem 1.5rem;
  background: none;
  border: none;
  border-bottom: 2px solid transparent;
  cursor: pointer;
  font-weight: 500;
  color: #6b7280;
  transition: all 0.2s;
}

.tab:hover {
  color: #374151;
}

.tab.active {
  color: #3b82f6;
  border-bottom-color: #3b82f6;
}

.tab-content {
  margin-top: 1rem;
}
</style>


