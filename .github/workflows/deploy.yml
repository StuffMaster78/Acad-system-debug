name: Deploy

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  # DigitalOcean Container Registry (DOCR)
  DO_REGISTRY: registry.digitalocean.com
  IMAGE_NAME: writing-system-backend
  
  # Alternative: GitHub Container Registry
  GH_REGISTRY: ghcr.io
  GH_IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push-do:
    name: Build and Push to DigitalOcean Container Registry
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to DigitalOcean Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DO_REGISTRY }}
          username: ${{ secrets.DO_REGISTRY_TOKEN }}
          password: ${{ secrets.DO_REGISTRY_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DO_REGISTRY }}/${{ secrets.DO_REGISTRY_NAME }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image to DOCR
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  build-and-push-gh:
    name: Build and Push to GitHub Container Registry (Backup)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.GH_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta-gh
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.GH_REGISTRY }}/${{ env.GH_IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image to GHCR
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta-gh.outputs.tags }}
          labels: ${{ steps.meta-gh.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  deploy-to-droplet:
    name: Deploy to DigitalOcean Droplet
    runs-on: ubuntu-latest
    needs: build-and-push-do
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy to DigitalOcean Droplet
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DO_DROPLET_HOST }}
          username: ${{ secrets.DO_DROPLET_USER }}
          key: ${{ secrets.DO_DROPLET_SSH_KEY }}
          port: ${{ secrets.DO_DROPLET_PORT || 22 }}
          script: |
            set -e
            echo "üöÄ Starting deployment..."
            
            # Navigate to application directory
            cd ${{ secrets.DO_APP_PATH || '/opt/writing_system_backend' }}
            
            # Pull latest code (if using git-based deployment)
            if [ -d .git ]; then
              git fetch origin
              git reset --hard origin/main || git reset --hard origin/master
            fi
            
            # Log in to DigitalOcean Container Registry
            echo "${{ secrets.DO_REGISTRY_TOKEN }}" | docker login ${{ env.DO_REGISTRY }} -u ${{ secrets.DO_REGISTRY_TOKEN }} --password-stdin
            
            # Pull latest Docker images
            echo "üì¶ Pulling latest Docker images..."
            docker-compose -f docker-compose.prod.yml pull || docker-compose pull
            
            # Stop existing containers gracefully
            echo "üõë Stopping existing containers..."
            docker-compose -f docker-compose.prod.yml down || docker-compose down || true
            
            # Start services
            echo "üöÄ Starting services..."
            docker-compose -f docker-compose.prod.yml up -d || docker-compose up -d
            
            # Wait for services to be ready
            echo "‚è≥ Waiting for services to be ready..."
            sleep 30
            
            # Run database migrations
            echo "üîß Running database migrations..."
            docker-compose -f docker-compose.prod.yml exec -T web python manage.py migrate --noinput || \
            docker-compose exec -T web python manage.py migrate --noinput || true
            
            # Collect static files
            echo "üìä Collecting static files..."
            docker-compose -f docker-compose.prod.yml exec -T web python manage.py collectstatic --noinput || \
            docker-compose exec -T web python manage.py collectstatic --noinput || true
            
            # Health check
            echo "üè• Running health check..."
            sleep 10
            docker-compose -f docker-compose.prod.yml ps || docker-compose ps
            
            # Clean up old images
            echo "üßπ Cleaning up old Docker images..."
            docker image prune -f || true
            
            echo "‚úÖ Deployment complete!"
      
      - name: Verify deployment
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DO_DROPLET_HOST }}
          username: ${{ secrets.DO_DROPLET_USER }}
          key: ${{ secrets.DO_DROPLET_SSH_KEY }}
          port: ${{ secrets.DO_DROPLET_PORT || 22 }}
          script: |
            cd ${{ secrets.DO_APP_PATH || '/opt/writing_system_backend' }}
            docker-compose -f docker-compose.prod.yml ps || docker-compose ps
            echo "‚úÖ All services are running!"

